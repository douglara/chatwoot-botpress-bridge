require "test_helper"

class BotpressReceiveEventTest < ActionDispatch::IntegrationTest
  setup do
    @event = JSON.parse(File.read(Rails.root.to_s + "/test/fixtures/botpress/cloud/events/message/created.json"))
    @botpress_list_messages_response = File.read(Rails.root.to_s + "/test/fixtures/botpress/cloud/api/conversation/list_messages_response.json")
  end

  test "success" do
    stub_request(:get, Regexp.new(ENV['BOTPRESS_ENDPOINT'])).
    to_return(status: 200, body: @botpress_list_messages_response, headers: {'Content-Type': 'application/json; charset=utf-8'})
    stub_request(:post, Regexp.new(ENV['CHATWOOT_ENDPOINT'])).
    to_return(status: 200, body: '{"id":64372,"content":"Testing","inbox_id":10,"conversation_id":11791,"message_type":1,"content_type":"text","content_attributes":{},"created_at":1656268461,"private":false,"source_id":null,"sender":{"id":3,"name":"Botpress Testing","avatar_url":"","type":"agent_bot"}}', headers: {'Content-Type': 'application/json; charset=utf-8'})

    result = Botpress::ReceiveEvent.call(event: @event)
    assert result.success?
  end

  test "invalid event" do
    result = Botpress::ReceiveEvent.call(event: {})
    assert result.failure?
  end

  test "message_metadata returns event metadata from conversation messages" do
    list_messages_stub = stub_request(:get, Regexp.new(ENV['BOTPRESS_ENDPOINT'])).
    to_return(status: 200, body: @botpress_list_messages_response, headers: {'Content-Type': 'application/json; charset=utf-8'})

    stub_request(:post, Regexp.new(ENV['CHATWOOT_ENDPOINT'])).
    to_return(status: 200, body: '{"messages":[{"id":"6","createdAt":"2025-12-19T11:47:40.880Z","conversationId":"29","userId":"user_02","payload":{"type":"text","text":"Como posso ajudar hoje, Douglas Lara?"},"metadata":{"citations":[]}},{"id":"5","createdAt":"2025-12-19T11:47:38.103Z","conversationId":"29","userId":"user_02","payload":{"type":"text","text":"Sou o assistente virtual"},"metadata":{"citations":[]}},{"id":"4","createdAt":"2025-12-19T11:47:37.840Z","conversationId":"29","userId":"user_02","payload":{"type":"text","text":"ðŸ‘‹ OlÃ¡, Douglas Lara!"},"metadata":{"citations":[]}},{"id":"3","createdAt":"2025-12-19T11:47:37.542Z","conversationId":"29","userId":"user_02","payload":{"type":"text","text":"ðŸ“‹ As conversas ficam registadas para melhor atendimento"},"metadata":{"citations":[]}},{"id":"2","createdAt":"2025-12-19T11:47:33.128Z","conversationId":"29","userId":"user_02","payload":{"type":"text","text":"teste"},"metadata":{"citations":[]}},{"id":"10","createdAt":"2025-12-19T11:47:32.238Z","conversationId":"29","userId":"1","payload":{"type":"text","text":"Teste 1"},"metadata":{"event":{"account":{"id":3,"name":"Conta 3"},"additional_attributes":{},"content_attributes":{},"content_type":"text","content":"Teste 1","conversation":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Api","contact_inbox":{"id":72,"contact_id":31,"inbox_id":20,"source_id":"34df1733-64f9-4ce4-83f9-703f4bdd00ff","created_at":"2025-12-19T11:47:30.828Z","updated_at":"2025-12-19T11:47:30.828Z","hmac_verified":false,"pubsub_token":"543123"},"id":29,"inbox_id":20,"messages":[{"id":2049,"content":"Teste 1","account_id":3,"inbox_id":20,"conversation_id":29,"message_type":0,"created_at":1766144850,"updated_at":"2025-12-19T11:47:30.917Z","private":false,"status":"sent","source_id":"WAID:22231","content_type":"text","content_attributes":{},"sender_type":"Contact","sender_id":31,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"Teste 1","sentiment":{},"conversation":{"assignee_id":null,"unread_count":1,"last_activity_at":1766144850,"contact_inbox":{"source_id":"34df1733-64f9-4ce4-83f9-703f4bdd00ff"}},"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":31,"identifier":"554199999996@s.whatsapp.net","name":"Douglas Lara","phone_number":"+554199999996","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":31,"identifier":"554199999996@s.whatsapp.net","name":"Douglas Lara","phone_number":"+554199999996","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":null,"hmac_verified":false},"status":"pending","custom_attributes":{},"snoozed_until":null,"unread_count":1,"first_reply_created_at":null,"priority":null,"waiting_since":1766144850,"agent_last_seen_at":0,"contact_last_seen_at":0,"last_activity_at":1766144850,"timestamp":1766144850,"created_at":1766144850,"updated_at":1766144850.9199739},"created_at":"2025-12-19T11:47:30.917Z","id":2049,"inbox":{"id":20,"name":"Numero"},"message_type":"incoming","private":false,"sender":{"account":{"id":3,"name":"Conta 3"},"additional_attributes":{},"avatar":"","custom_attributes":{},"email":null,"id":31,"identifier":"554199999996@s.whatsapp.net","name":"Douglas Lara","phone_number":"+554199999996","thumbnail":"","blocked":false},"source_id":"WAID:22231","event":"message_created","controller":"chatwoot","action":"webhook","chatwoot":{"account":{"id":3,"name":"Conta 3"},"additional_attributes":{},"content_attributes":{},"content_type":"text","content":"Teste 1","conversation":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Api","contact_inbox":{"id":72,"contact_id":31,"inbox_id":20,"source_id":"34df1733-64f9-4ce4-83f9-703f4bdd00ff","created_at":"2025-12-19T11:47:30.828Z","updated_at":"2025-12-19T11:47:30.828Z","hmac_verified":false,"pubsub_token":"543123"},"id":29,"inbox_id":20,"messages":[{"id":2049,"content":"Teste 1","account_id":3,"inbox_id":20,"conversation_id":29,"message_type":0,"created_at":1766144850,"updated_at":"2025-12-19T11:47:30.917Z","private":false,"status":"sent","source_id":"WAID:22231","content_type":"text","content_attributes":{},"sender_type":"Contact","sender_id":31,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"Teste 1","sentiment":{},"conversation":{"assignee_id":null,"unread_count":1,"last_activity_at":1766144850,"contact_inbox":{"source_id":"34df1733-64f9-4ce4-83f9-703f4bdd00ff"}},"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":31,"identifier":"554199999996@s.whatsapp.net","name":"Douglas Lara","phone_number":"+554199999996","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":31,"identifier":"554199999996@s.whatsapp.net","name":"Douglas Lara","phone_number":"+554199999996","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":null,"hmac_verified":false},"status":"pending","custom_attributes":{},"snoozed_until":null,"unread_count":1,"first_reply_created_at":null,"priority":null,"waiting_since":1766144850,"agent_last_seen_at":0,"contact_last_seen_at":0,"last_activity_at":1766144850,"timestamp":1766144850,"created_at":1766144850,"updated_at":1766144850.9199739},"created_at":"2025-12-19T11:47:30.917Z","id":2049,"inbox":{"id":20,"name":"Numero 3"},"message_type":"incoming","private":false,"sender":{"account":{"id":3,"name":"Conta 3"},"additional_attributes":{},"avatar":"","custom_attributes":{},"email":null,"id":31,"identifier":"554199999996@s.whatsapp.net","name":"Douglas Lara","phone_number":"+554199999996","thumbnail":"","blocked":false},"source_id":"WAID:22231","event":"message_created"}}}}],"meta":{}}', headers: {'Content-Type': 'application/json; charset=utf-8'})

    result = Botpress::ReceiveEvent.call(event: @event)

    assert result.success?
    assert_requested list_messages_stub
  end
end
